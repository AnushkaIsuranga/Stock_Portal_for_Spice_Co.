<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="Styles/Images/p3.jpg">
        <link rel="stylesheet" href="Styles/theme.css">
        <link rel="stylesheet" href="Styles/bootstrap/bootstrap-5.0.2-dist/css/bootstrap.min.css">
    <title>Manager</title>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Settitng elemets to variables
            const searchUserIDOrder = document.getElementById('txtUserID_SearchOrder');
            const yearSelectOrder = document.getElementById('yearOrder');
            const monthSelectOrder = document.getElementById('monthOrder');
            const dateSelectOrder = document.getElementById('dateOrder');

            const searchUserIDUser = document.getElementById('txtUserID_SearchUser');

            // Initialize year, month, and date selects for order filtering
            yearSelectOrder.innerHTML = '<option value="0">All Years</option>';
            for (let year = 2023; year <= 4000; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.text = year;
                yearSelectOrder.appendChild(option);
            }

            monthSelectOrder.innerHTML = '<option value="0">All Months</option>';
            for (let month = 1; month <= 12; month++) {
                const option = document.createElement('option');
                option.value = month;
                option.text = month;
                monthSelectOrder.appendChild(option);
            }

            dateSelectOrder.innerHTML = '<option value="0">All Dates</option>';
            for (let date = 1; date <= 31; date++) {
                const option = document.createElement('option');
                option.value = date;
                option.text = date;
                dateSelectOrder.appendChild(option);
            }

            // Filtering order table records
            function filterDataOrder() {
                var userID = searchUserIDOrder.value;
                const selectedYear = yearSelectOrder.value;
                const selectedMonth = monthSelectOrder.value;
                const selectedDate = dateSelectOrder.value;

                const xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState === 4 && this.status === 200) {
                        console.log(this.responseText); // Debugging line
                        const filteredData = JSON.parse(this.responseText);
                        updateTableOrder(filteredData);
                    }
                };
                xhttp.open("POST", "filter_data_manager_order.php", true);
                xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                xhttp.send("userId=" + userID + "&year=" + selectedYear + "&month=" + selectedMonth + "&date=" + selectedDate);
            }

            // Updating order table
            function updateTableOrder(data) {
                const tableBody = document.getElementById("tableBodyOrder");
                tableBody.innerHTML = "";

                if (data.length === 0) {
                    tableBody.innerHTML = "<tr><td colspan='8'>No records found based on your filter selection.</td></tr>";
                } else {
                    data.forEach(row => {
                        const tableRow = document.createElement("tr");
                        tableRow.innerHTML = `
                            <td>${row["Order_ID"]}</td>
                            <td>${row["User_ID"]}</td>
                            <td>${row["Date"]}</td>
                            <td>${row["Quantity"]}</td>
                            <td>${row["Price_Rs"]}</td>
                            <td>${row["Add_Line1"]}</td>
                            <td>${row["Add_Line2"]}</td>
                            <td>${row["needs_verification"]}</td>
                        `;
                        tableBody.appendChild(tableRow);
                    });
                }
            }

            // Filtering user table records
            function filterDataUser() {
                var userID = searchUserIDUser.value;

                const xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState === 4 && this.status === 200) {
                        console.log(this.responseText); // Debugging line
                        const filteredData = JSON.parse(this.responseText);
                        updateTableUser(filteredData);
                    }
                };
                xhttp.open("POST", "filter_data_manager_user.php", true);
                xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                xhttp.send("userId=" + userID);
            }

            // Updating user table
            function updateTableUser(data) {
                const tableBody = document.getElementById("tableBodyUser");
                tableBody.innerHTML = "";

                if (data.length === 0) {
                    tableBody.innerHTML = "<tr><td colspan='8'>No records found based on your filter selection.</td></tr>";
                } else {
                    data.forEach(row => {
                        const tableRow = document.createElement("tr");
                        tableRow.innerHTML = `
                            <td>${row["User_ID"]}</td>
                            <td>${row["Email"]}</td>
                            <td>${row["F_Name"]}</td>
                            <td>${row["L_Name"]}</td>
                            <td>${row["U_Name"]}</td>
                            <td>${row["NIC"]}</td>
                            <td>${row["Tel_No"]}</td>
                        `;
                        tableBody.appendChild(tableRow);
                    });
                }
            }

            // Setting to run filterData functions when given elements change
            searchUserIDOrder.addEventListener('change', filterDataOrder);
            yearSelectOrder.addEventListener('change', filterDataOrder);
            monthSelectOrder.addEventListener('change', filterDataOrder);
            dateSelectOrder.addEventListener('change', filterDataOrder);

            searchUserIDUser.addEventListener('change', filterDataUser);

            filterDataOrder();
            filterDataUser();
        });
    </script>
    <style>
        body{
            font-family: inder;
        }

        #msg{
            animation: cssAnimation 0s ease-in 5s forwards;
            animation-fill-mode: forwards;
        }

        @keyframes cssAnimation {
            to {
                width: 0;
                height: 0;
                overflow: hidden;
                visibility: hidden;
            }
        }
        
        @font-face {
            font-family: inder;
            src: url('./Styles/fonts/Inder-Regular.ttf');
        }

        .scrollable-table {
            max-height: 400px; /* Adjust as needed */
            overflow-y: auto;
            display: block;
        }

        #footer {
            background-image: url(/Styles/Images/perahara.png);
            height: 200px;
            margin-top: auto;
            text-align: right;
            padding-right: 30px;
            margin-right: 0;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex-shrink: 0;
        }

        #logo{
            height: 150px;
        }


        @media(max-width: 700px){

                #logo{
                    height: 100px;
                }

                #submitButton{
                    height: 30px;
                    font-size: 10px;
                }
            }

    </style>
</head>
<body>
    <div class="row-fluid">
        <nav class="navbar navbar-expand-lg navbar-custom fixed-top">
            <div class="container-fluid d-flex justify-content-between align-items-center">
                <div class="col-4">
                    <a href="main.html"><img src="Styles/Images/p3.png" id="logo" class="rounded navbar-logo" alt="Dilthira pepper logo"></a>
                </div>
                <div class="col-4" style="text-align: center; font-size: 4vw;">
                    <h4 style="color: white; font-size: 4vw;">Welcome, Manager</h4>
                </div>
                <div class="col-4" style="text-align: right; margin-right: -30px;">
                    <a href="logout.php">
                        <button type="button" class="btn btn-primary" id="submitButton" style="border-radius: 20px;">Log-Out</button>
                    </a>
                </div>
            </div>
        </nav>

    </div>

    <div class="row-fluid">
        <div class="container-fluid" style="margin: auto; margin-top: 200px;">
            <div class="row-fluid" style="justify-content: center; text-align: center;">
                <div class="row">
                    <div class="col-md" style="justify-content: center; text-align: left; padding: 50px;">
                        <!-- Order details panale -->
                        <h3>Order Details</h3>
                    
                        <label for="txtUserID_SearchOrder">Enter User ID to select the order list:</label><br>
                        <input type="text" name="userIdSearchOrder" id="txtUserID_SearchOrder" class="form-control" ><br><br>
                        <label for="txtOrderID_SearchOrder">Enter Order ID to select the order list:</label><br>
                        <input type="text" name="orderIdSearchOrder" id="txtOrderID_SearchOrder" class="form-control" ><br><br>
                        <div class="row">
                            <div class="col">
                                <select id="yearOrder" class="form-control" ></select>
                            </div>
                            <div class="col">
                                <select id="monthOrder" class="form-control" ></select>
                            </div>
                            <div class="col">
                                <select id="dateOrder" class="form-control" ></select>
                            </div>
                        </div>
                    </div>
                    <div class="col-md" style="padding: 50px;  margin-bottom: 60px;">
                        <div class="row" style="height: 40px;">
                            <!-- Available stock update panale -->
                            <h2>Available Stock</h2>
                        
                            <p><?php echo $stock_data['available_stock']; ?> kg</p>
                        
                            <?php if($stock_data['available_stock'] < 5){
                                $sms = "stock_limited";
                                require 'sendSMS.php';
                            } 
                            
                            if($stock_data['available_stock'] < 0){
                                $sms = "out_of_stock";
                                require 'sendSMS.php';
                            }?>
                        </div>
                        <div class="row" style="height: 40px; margin-top: 9vh;">
                            <!-- Generate monthly report -->
                            <h2>Generate Monthly Report</h2><br><br><br>
                    
                            <div class="col" style="text-align: left;">
                                <form action="monthly_report.php" method="post" target="reportFrame">
                                    <div class="row">
                                        <div class="col">
                                            <label for="month">Month:</label>
                                            <select name="month" id="month" class="form-control" required>
                                                <?php for ($m = 1; $m <= 12; $m++): ?>
                                                    <option value="<?php echo $m; ?>"><?php echo date('F', mktime(0, 0, 0, $m, 10)); ?></option>
                                                <?php endfor; ?>
                                            </select>
                                        </div>
                                        <div class="col">
                                            <label for="year">Year:</label>
                                            <select name="year" id="year" class="form-control" required>
                                                <?php for ($y = date('Y'); $y >= 2000; $y--): ?>
                                                    <option value="<?php echo $y; ?>"><?php echo $y; ?></option>
                                                <?php endfor; ?>
                                            </select><br>
                                        </div>
                                    </div>
                                    <button class="form-control" type="submit" style="background-color: black; color: white;">Get Report</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div><br><br><br>
            
                <!-- Order table -->
                <div class="scrollable-table">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Order ID</th>
                                <th scope="col">User ID</th>
                                <th scope="col">Date</th>
                                <th scope="col">Quantity</th>
                                <th scope="col">Price</th>
                                <th scope="col">Address Line 1</th>
                                <th scope="col">Address Line 2</th>
                                <th scope="col">Verification Status</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyOrder">
                            <!-- Table content will be dynamically populated here -->
                        </tbody>
                    </table><br><br>
                </div>

                <div class="row">
                    <div class="col-md-6" style="margin: 20px; margin-top: 35px; text-align: left;">
                        <!-- User details search panale -->
                        <h3>User Details</h3>
                    
                        <label for="txtUserID_SearchUser">Enter User ID to select the user list:</label><br>
                        <input type="text" name="userIdSearchUser" class="form-control" id="txtUserID_SearchUser"><br><br>
                    </div>
                    <div class="col-md-6 none"></div>
                </div>
            
                <!-- User table -->
                <div class="scrollable-table">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">User ID</th>
                                <th scope="col">Email</th>
                                <th scope="col">First Name</th>
                                <th scope="col">Last Name</th>
                                <th scope="col">Username</th>
                                <th scope="col">NIC</th>
                                <th scope="col">Telephone Number</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyUser">
                            <!-- Table content will be dynamically populated here -->
                        </tbody>
                    </table>
                </div><br><br>

                <!-- Order validation panal -->
                <h2>New Orders That Need Verification:</h2><br>
            
                <?php
                if ($result->num_rows > 0) {
                    echo "<div class='scrollable-table'>";
                    echo "<table class='table'>";
                    echo "<tr><th scope='col'>Order ID</th><th scope='col'>User ID</th><th scope='col'>Date</th><th scope='col'>Quantity</th><th scope='col'>Price</th><th scope='col'>Address Line 1</th><th scope='col'>Address Line 2</th><th scope='col'>Recite</th><th scope='col'>Verify</th></tr>";
                    while ($row = $order_result->fetch_assoc()) {
                        echo "<tr>";
                        echo "<td>" . $row['Order_ID'] . "</td>";
                        echo "<td>" . $row['User_ID'] . "</td>";
                        echo "<td>" . $row['Date'] . "</td>";
                        echo "<td>" . $row['Quantity'] . "</td>";
                        echo "<td>" . $row['Price_Rs'] . "</td>";
                        echo "<td>" . $row['Add_Line1'] . "</td>";
                        echo "<td>" . $row['Add_Line2'] . "</td>";
                        echo "<td><a href='" . $row['Recite'] . "' target='_blank'>View Receipt</a></td>";
                        echo "<td><form method='post'><input type='hidden' name='order_id' value='" . $row['Order_ID'] . "'><input type='submit' name='verify_order' value='Verify' style='background-color: black; color: white; width: 70px; height: 40px; text-align: center; padding: 0;'></form></td>";
                        echo "<td><form method='post'><input type='hidden' name='order_id' value='" . $row['Order_ID'] . "'><input type='submit' name='deny_order' value='Deny' style='background-color: black; color: white; width: 70px; height: 40px; text-align: center; padding: 0;'></form></td>";
                        echo "</tr>";
                    }
                    echo "</table>";
                    echo "</div>";
                } else {
                    echo "No new orders need verification.";
                }
                ?>
            </div>
        </div>
    </div>

    <div class="row-fluid">
        <nav class="navbar navbar-expand-lg navbar-custom" id="footer">
            <div class="container-fluid d-flex justify-content-between align-items-center" style="text-align: right; padding-right: 30px;">
                <div class="col" style="font-size: 25px; font-weight: bolder; color: white;">Contact Us<br>
                <a href="mailto:your-email@example.com" style="color: white; font-size: 15px; text-decoration: none;">
                    dilthira@gmail.com
                    <img src="Styles/Images/icons/mail-outline.svg" alt="email" class="logoo">
                </a>
                <br>
                <a href="tel:+9434567890" style="color: white; font-size: 15px; text-decoration: none;">
                    +94 345 67890
                    <img src="Styles/Images/icons/call-outline.svg" alt="call" class="logoo">
                </a>
                <br>
                <a href="https://www.facebook.com/yourprofile" target="_blank" style="color: white; font-size: 15px; text-decoration: none;">
                    Facebook
                    <img src="Styles/Images/icons/logo-facebook.svg" alt="facebook" class="logoo">
                </a>
            </div>
        </nav>
    </div>
    <script src="Styles/bootstrap/bootstrap-5.0.2-dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
